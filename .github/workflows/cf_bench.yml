name: Cloudflare Worker Benchmark

on:
  push:
    paths-ignore: ["docs/**", "**.md"]
    branches:
      - main
  pull_request:
    paths-ignore: ["docs/**", "**.md"]
    types: [opened, reopened, synchronize, labeled]

jobs:
  cloudflare_worker_benchmark:
    name: Cloudflare Worker Benchmark
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install Dependencies
        working-directory: ./cloudflare
        run: npm install

      - name: Compile Cloudflare Worker
        uses: ./
        with:
          working-directory: ./cloudflare
          wait-on: "http://localhost:19194"
          start: npm run dev

      - name: Warm-up Requests
        run: |
          curl -i -X POST -d '{"query": "{posts{title}}"}' http://localhost:19194/?config=https://raw.githubusercontent.com/tailcallhq/tailcall/main/ci-benchmark/benchmark.graphql

      - name: Install Wrk
        run: |
          sudo apt-get install -y wrk

      - name: Warmup Wrk
        working-directory: ci-benchmark
        run: |
          wrk -d 10 -t 4 -c 100 -s wrk.lua http://localhost:19194/?config=https://raw.githubusercontent.com/tailcallhq/tailcall/main/ci-benchmark/benchmark.graphql

      - name: Benchmark with Wrk
        working-directory: ci-benchmark
        run: |
          wrk -d 30 -t 4 -c 100 -s wrk.lua http://localhost:19194/?config=https://raw.githubusercontent.com/tailcallhq/tailcall/main/ci-benchmark/benchmark.graphql > wrk-output-cf.txt

      - name: Convert Wrk Output to Markdown
        working-directory: ci-benchmark
        run: |
          node wrk-output-to-md.js wrk-output-cf.txt > cloudflare_benchmark.md

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v4
        with:
          name: cloudflare_benchmark
          path: ci-benchmark/cloudflare_benchmark.md

  Cache_Benchmarks:
    name: Cache Micro Benchmarks result
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main')
    permissions:
      pull-requests: write
      contents: write
    runs-on: benchmarking-runner
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Run Benchmarks
        run: |
          cargo install cargo-criterion rust-script
          cargo criterion --message-format=json > benches/main_benchmarks.json
          ./scripts/json_to_md.rs benches/main_benchmarks.json > benches/main_benchmarks.md
          cat benches/main_benchmarks.md

      - name: Cache Criterion Benchmarks Json
        uses: actions/cache@v4
        with:
          path: benches/main_benchmarks.json
          key: criterion_benchmarks_${{ github.sha }}

  Criterion_Compare:
    name: Comparing Micro Benchmarks
    if: "contains(github.event.pull_request.labels.*.name, 'ci: benchmark')"
    runs-on: benchmarking-runner
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Run Criterion Benchmarks
        run: |
          cargo install cargo-criterion rust-script
          cargo criterion --message-format=json > benches/benchmarks.json
          ./scripts/json_to_md.rs benches/benchmarks.json > benches/change_benchmarks.md

      - name: Print Criterion Benchmarks
        run: cat benches/change_benchmarks.md

      - name: Restore file
        uses: actions/cache@v4
        with:
          path: benches/main_benchmarks.json
          key: criterion_benchmarks_${{ github.event.pull_request.base.sha }}
          fail-on-cache-miss: true

      - name: Print Benchmark Comparision
        run: ./scripts/criterion_compare.rs benches/main_benchmarks.json benches/benchmarks.json table

      - name: Check Degradation
        run: ./scripts/criterion_compare.rs  benches/main_benchmarks.json benches/benchmarks.json check
